
{% extends "base.html" %}

{% block title %}Chat dengan {{ other_user.get_full_name() }} - BarterHub{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Chat Header -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-circle fa-2x me-3"></i>
                            <div>
                                <h5 class="mb-0">{{ other_user.get_full_name() }}</h5>
                                <small class="opacity-75">
                                    {% if chat_type == 'seller' %}
                                    Penjual - @{{ other_user.username }}
                                    {% else %}
                                    Pembeli - @{{ other_user.username }}
                                    {% endif %}
                                    {% if current_product %}
                                    | Produk: {{ current_product.title }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% if conversation and conversation.status %}
                        <div class="text-end">
                            <span class="badge bg-light text-dark">
                                {% if conversation.status == 'active' %}
                                üí¨ Aktif
                                {% elif conversation.status == 'negotiating' %}
                                ü§ù Negosiasi
                                {% elif conversation.status == 'deal_pending' %}
                                ‚è≥ Menunggu Deal
                                {% elif conversation.status == 'completed' %}
                                ‚úÖ Deal Selesai
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                        <div class="d-flex gap-2">
                            <span class="badge bg-success">Online</span>
                            <button class="btn btn-sm btn-light" onclick="window.close()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row flex-grow-1">
        <!-- Chat Messages -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <!-- Messages Container -->
                    <div class="messages-container flex-grow-1 overflow-auto mb-3" id="messagesContainer" style="height: 400px;">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-comments fa-2x mb-2"></i>
                            <p>Mulai percakapan dengan {{ other_user.get_full_name() }}</p>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="message-input">
                        <form id="chatForm" class="d-flex gap-2">
                            <input type="hidden" id="receiverId" value="{{ other_user.id }}">
                            <input type="hidden" id="productId" value="">
                            <div class="flex-grow-1">
                                <input type="text" id="messageInput" class="form-control" 
                                       placeholder="Ketik pesan..." required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Sidebar -->
        <div class="col-lg-4">
            {% if chat_type == 'seller' and products %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-store me-2"></i>Produk dari {{ other_user.get_full_name() }}</h6>
                </div>
                <div class="card-body">
                    {% for product in products %}
                    <div class="product-item border-bottom pb-2 mb-2 cursor-pointer" onclick="selectProduct({{ product.id }}, '{{ product.title }}')">
                        <div class="d-flex">
                            <div class="me-2">
                                {% if product.image_url %}
                                <img src="{{ product.image_url }}" width="50" height="50" class="rounded" alt="{{ product.title }}">
                                {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 small">{{ product.title }}</h6>
                                <div class="d-flex gap-1">
                                    <span class="badge bg-primary small">{{ product.get_final_barter_value() }} pts</span>
                                    <span class="badge bg-secondary small">{{ product.condition }}</span>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="startProductChat({{ product.id }}, '{{ product.title }}')">
                                    <i class="fas fa-comment"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% elif chat_type == 'buyer' and cart_items %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Keranjang {{ other_user.get_full_name() }}</h6>
                </div>
                <div class="card-body">
                    {% for cart_item in cart_items %}
                    <div class="cart-item border-bottom pb-2 mb-2">
                        <div class="d-flex">
                            <div class="me-2">
                                {% if cart_item.product.image_url %}
                                <img src="{{ cart_item.product.image_url }}" width="50" height="50" class="rounded" alt="{{ cart_item.product.title }}">
                                {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 small">{{ cart_item.product.title }}</h6>
                                <small class="text-muted">Dari toko Anda</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Aksi Cepat</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if chat_type == 'seller' %}
                        <button class="btn btn-outline-success btn-sm" onclick="sendQuickMessage('Apakah produk ini masih tersedia?')">
                            <i class="fas fa-question-circle me-1"></i>Tanya Ketersediaan
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="sendQuickMessage('Bisa nego harganya?')">
                            <i class="fas fa-handshake me-1"></i>Tanya Negosiasi
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="sendQuickMessage('Bagaimana kondisi barangnya?')">
                            <i class="fas fa-search me-1"></i>Tanya Kondisi
                        </button>
                        {% else %}
                        <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMessage('Terima kasih sudah tertarik dengan produk saya')">
                            <i class="fas fa-thumbs-up me-1"></i>Ucapan Terima Kasih
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="sendQuickMessage('Produk masih tersedia dan siap dikirim')">
                            <i class="fas fa-check me-1"></i>Konfirmasi Tersedia
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="col-12 mt-3">
            <div class="card" style="height: 500px;">
                <div class="card-body d-flex flex-column p-0">
                    <!-- Messages Area -->
                    <div id="messagesArea" class="flex-grow-1 p-3" style="overflow-y: auto; max-height: 350px;">
                        <div id="messagesList">
                            <!-- Messages will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="border-top p-2">
                        <div class="d-flex gap-2 mb-2">
                            {% if chat_type == 'seller' and current_product %}
                            <button class="btn btn-sm btn-outline-success" onclick="sendQuickOffer()">
                                üí∞ Tawarkan Harga
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="sendQuickMessage('Produk masih tersedia dan siap dikirim')">
                                ‚úÖ Konfirmasi Tersedia
                            </button>
                            {% elif chat_type == 'buyer' and current_product %}
                            <button class="btn btn-sm btn-outline-primary" onclick="sendQuickMessage('Apakah produk ini masih tersedia?')">
                                ‚ùì Tanya Ketersediaan
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="sendQuickOffer()">
                                ü§ù Buat Penawaran
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="border-top p-3">
                        <form id="messageForm" class="d-flex gap-2">
                            <input type="hidden" id="receiverId" value="{{ other_user.id }}">
                            <input type="hidden" id="productId" value="{{ current_product.id if current_product else '' }}">
                            <input type="hidden" id="conversationId" value="{{ conversation_id }}">
                            <input type="hidden" id="messageType" value="text">
                            
                            <div class="flex-grow-1">
                                <input type="text" id="messageInput" class="form-control" placeholder="Ketik pesan..." required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Offer Modal -->
<div class="modal fade" id="offerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üí∞ Buat Penawaran</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="offerForm">
                    <div class="mb-3">
                        <label class="form-label">Harga Penawaran (Rp)</label>
                        <input type="number" id="offerPrice" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jumlah</label>
                        <input type="number" id="offerQuantity" class="form-control" value="1" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pesan Tambahan</label>
                        <textarea id="offerMessage" class="form-control" rows="3" placeholder="Tuliskan pesan tambahan..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="submitOffer()">Kirim Penawaran</button>
            </div>
        </div>
    </div>
</div>

<!-- Deal Response Modal -->
<div class="modal fade" id="dealResponseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dealResponseTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dealResponseContent"></div>
                <form id="dealResponseForm">
                    <input type="hidden" id="responseMessageId" value="">
                    <input type="hidden" id="responseAction" value="">
                    
                    <div class="mb-3" id="counterPriceDiv" style="display: none;">
                        <label class="form-label">Harga Counter (Rp)</label>
                        <input type="number" id="counterPrice" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Pesan Respons</label>
                        <textarea id="responseMessage" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer" id="dealResponseButtons">
                <!-- Buttons will be dynamically added -->
            </div>
        </div>
    </div>
</div>

<script>
let conversationId = '{{ conversation_id }}';
let currentProductId = {{ current_product.id if current_product else 'null' }};

// Load messages on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMessages();
    setInterval(loadMessages, 3000); // Refresh every 3 seconds
});

// Load messages
function loadMessages() {
    fetch(`/get_chat_messages/${conversationId}`)
        .then(response => response.json())
        .then(data => {
            if (data.messages) {
                displayMessages(data.messages);
                updateConversationStatus(data.conversation);
            }
        })
        .catch(error => console.error('Error:', error));
}

// Display messages
function displayMessages(messages) {
    const messagesList = document.getElementById('messagesList');
    messagesList.innerHTML = '';
    
    messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message mb-3 ${msg.sender_id == {{ current_user.id }} ? 'text-end' : 'text-start'}`;
        
        let messageContent = '';
        
        if (msg.message_type === 'offer') {
            messageContent = `
                <div class="card ${msg.sender_id == {{ current_user.id }} ? 'bg-primary text-white' : 'bg-light'}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>üí∞ Penawaran</strong>
                            <span class="badge ${msg.is_expired ? 'bg-danger' : 'bg-success'}">
                                ${msg.is_expired ? 'Expired' : 'Aktif'}
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Rp ${parseInt(msg.offer_price).toLocaleString()}</strong>
                            ${msg.offer_quantity > 1 ? ` x ${msg.offer_quantity}` : ''}
                        </div>
                        <p class="mb-2">${msg.message}</p>
                        <small class="opacity-75">${msg.created_at}</small>
                        
                        ${msg.sender_id != {{ current_user.id }} && !msg.is_expired && msg.deal_accepted === null ? `
                            <div class="mt-2">
                                <button class="btn btn-sm btn-success me-1" onclick="respondToOffer(${msg.id}, 'accept')">
                                    ‚úÖ Terima
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="respondToOffer(${msg.id}, 'counter')">
                                    üîÑ Counter
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="respondToOffer(${msg.id}, 'reject')">
                                    ‚ùå Tolak
                                </button>
                            </div>
                        ` : ''}
                        
                        ${msg.deal_accepted === true ? '<div class="mt-2 text-success">‚úÖ Deal Diterima!</div>' : ''}
                        ${msg.deal_accepted === false ? '<div class="mt-2 text-danger">‚ùå Deal Ditolak</div>' : ''}
                    </div>
                </div>
            `;
        } else if (msg.message_type === 'deal') {
            messageContent = `
                <div class="card bg-success text-white">
                    <div class="card-body p-3">
                        <div class="mb-2"><strong>üéâ Deal Final</strong></div>
                        <p class="mb-2">${msg.message}</p>
                        <small class="opacity-75">${msg.created_at}</small>
                    </div>
                </div>
            `;
        } else {
            messageContent = `
                <div class="d-flex ${msg.sender_id == {{ current_user.id }} ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="message-bubble ${msg.sender_id == {{ current_user.id }} ? 'bg-primary text-white' : 'bg-light'} rounded p-3" style="max-width: 70%;">
                        <p class="mb-1">${msg.message}</p>
                        <small class="opacity-75">${msg.created_at}</small>
                    </div>
                </div>
            `;
        }
        
        messageDiv.innerHTML = messageContent;
        messagesList.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    document.getElementById('messagesArea').scrollTop = document.getElementById('messagesArea').scrollHeight;
}

// Send message
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage();
});

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    const formData = new FormData();
    formData.append('receiver_id', document.getElementById('receiverId').value);
    formData.append('product_id', document.getElementById('productId').value);
    formData.append('message', message);
    formData.append('message_type', document.getElementById('messageType').value);
    
    fetch('/send_chat_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            document.getElementById('messageType').value = 'text';
            loadMessages();
        }
    })
    .catch(error => console.error('Error:', error));
}

// Quick message
function sendQuickMessage(message) {
    document.getElementById('messageInput').value = message;
    sendMessage();
}

// Quick offer
function sendQuickOffer() {
    document.getElementById('offerModal').style.display = 'block';
    const modal = new bootstrap.Modal(document.getElementById('offerModal'));
    modal.show();
}

// Submit offer
function submitOffer() {
    const price = document.getElementById('offerPrice').value;
    const quantity = document.getElementById('offerQuantity').value;
    const message = document.getElementById('offerMessage').value;
    
    if (!price) return;
    
    const formData = new FormData();
    formData.append('receiver_id', document.getElementById('receiverId').value);
    formData.append('product_id', document.getElementById('productId').value);
    formData.append('message', message || `Penawaran untuk produk ini: Rp ${parseInt(price).toLocaleString()}`);
    formData.append('message_type', 'offer');
    formData.append('offer_price', price);
    formData.append('offer_quantity', quantity);
    
    fetch('/send_chat_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('offerModal')).hide();
            document.getElementById('offerForm').reset();
            loadMessages();
        }
    })
    .catch(error => console.error('Error:', error));
}

// Respond to offer
function respondToOffer(messageId, action) {
    document.getElementById('responseMessageId').value = messageId;
    document.getElementById('responseAction').value = action;
    
    const modal = new bootstrap.Modal(document.getElementById('dealResponseModal'));
    const title = document.getElementById('dealResponseTitle');
    const content = document.getElementById('dealResponseContent');
    const buttons = document.getElementById('dealResponseButtons');
    const counterDiv = document.getElementById('counterPriceDiv');
    
    if (action === 'accept') {
        title.textContent = '‚úÖ Terima Penawaran';
        content.innerHTML = '<p>Anda akan menerima penawaran ini. Lanjutkan?</p>';
        counterDiv.style.display = 'none';
        buttons.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-success" onclick="submitDealResponse()">Ya, Terima</button>
        `;
    } else if (action === 'reject') {
        title.textContent = '‚ùå Tolak Penawaran';
        content.innerHTML = '<p>Anda akan menolak penawaran ini. Berikan alasan (opsional):</p>';
        counterDiv.style.display = 'none';
        buttons.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-danger" onclick="submitDealResponse()">Tolak</button>
        `;
    } else if (action === 'counter') {
        title.textContent = 'üîÑ Counter Offer';
        content.innerHTML = '<p>Berikan harga counter untuk penawaran ini:</p>';
        counterDiv.style.display = 'block';
        buttons.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-warning" onclick="submitDealResponse()">Kirim Counter</button>
        `;
    }
    
    modal.show();
}

// Submit deal response
function submitDealResponse() {
    const formData = new FormData();
    formData.append('message_id', document.getElementById('responseMessageId').value);
    formData.append('action', document.getElementById('responseAction').value);
    formData.append('response_message', document.getElementById('responseMessage').value);
    
    const counterPrice = document.getElementById('counterPrice').value;
    if (counterPrice) {
        formData.append('counter_price', counterPrice);
    }
    
    fetch('/respond_to_offer', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('dealResponseModal')).hide();
            document.getElementById('dealResponseForm').reset();
            loadMessages();
        }
    })
    .catch(error => console.error('Error:', error));
}

// Start product-specific chat
function startProductChat(productId, productTitle) {
    window.location.href = `/chat_with_seller/{{ other_user.id }}?product_id=${productId}`;
}

// Update conversation status
function updateConversationStatus(conversation) {
    if (conversation) {
        // Update UI based on conversation status
        console.log('Conversation status:', conversation.status);
    }
}
</script>

<style>
.cursor-pointer {
    cursor: pointer;
}

.product-item:hover, .cart-item:hover {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 5px;
}

.message-bubble {
    max-width: 70%;
    margin-bottom: 10px;
}

.message-bubble.sent {
    margin-left: auto;
    text-align: right;
}

.message-bubble.received {
    margin-right: auto;
}

.message-content {
    padding: 8px 12px;
    border-radius: 15px;
    word-wrap: break-word;
}

.message-bubble.sent .message-content {
    background-color: #007bff;
    color: white;
}

.message-bubble.received .message-content {
    background-color: #e9ecef;
    color: #333;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 2px;
}
</style>

<script>
let selectedProductId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadMessages();
    setInterval(loadMessages, 3000); // Refresh every 3 seconds
});

document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage();
});

function loadMessages() {
    const receiverId = document.getElementById('receiverId').value;
    
    fetch(`/get_chat_messages/${receiverId}`)
        .then(response => response.json())
        .then(data => {
            displayMessages(data.messages);
        })
        .catch(error => {
            console.error('Error loading messages:', error);
        });
}

function displayMessages(messages) {
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '';
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-comments fa-2x mb-2"></i>
                <p>Belum ada percakapan. Mulai chat dengan {{ other_user.get_full_name() }}</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(message => {
        const messageDiv = document.createElement('div');
        const isSent = message.sender_id == {{ current_user.id }};
        
        messageDiv.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
            <div class="message-content">
                ${message.product_title ? `<small class="text-muted d-block">Re: ${message.product_title}</small>` : ''}
                ${message.message}
            </div>
            <div class="message-time">${message.created_at}</div>
        `;
        
        container.appendChild(messageDiv);
    });
    
    container.scrollTop = container.scrollHeight;
}

function sendMessage() {
    const receiverId = document.getElementById('receiverId').value;
    const productId = document.getElementById('productId').value;
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    const formData = new FormData();
    formData.append('receiver_id', receiverId);
    formData.append('message', message);
    if (productId) {
        formData.append('product_id', productId);
    }
    
    fetch('/send_chat_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            loadMessages();
        } else {
            alert('Gagal mengirim pesan');
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
    });
}

function selectProduct(productId, productTitle) {
    selectedProductId = productId;
    document.getElementById('productId').value = productId;
    
    // Visual feedback
    document.querySelectorAll('.product-item').forEach(item => {
        item.classList.remove('bg-primary', 'text-white');
    });
    
    event.currentTarget.classList.add('bg-primary', 'text-white');
    
    // Update placeholder
    document.getElementById('messageInput').placeholder = `Tanya tentang: ${productTitle}`;
}

function sendQuickMessage(message) {
    document.getElementById('messageInput').value = message;
    sendMessage();
}
</script>
{% endblock %}
