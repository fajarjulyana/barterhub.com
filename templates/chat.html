{% extends "base.html" %}

{% block title %}Chat dengan {{ other_user.get_full_name() }} - BarterHub{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Chat Header -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-user-circle fa-2x me-3"></i>
                    <div>
                        <h5 class="mb-0">{{ other_user.get_full_name() }}</h5>
                        <small class="opacity-75">
                            {% if chat_type == 'seller' %}
                            <i class="fas fa-store me-1"></i>Penjual - @{{ other_user.username }}
                            {% else %}
                            <i class="fas fa-shopping-cart me-1"></i>Pembeli - @{{ other_user.username }}
                            {% endif %}
                            {% if current_product %}
                            | Produk: {{ current_product.title }}
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <span class="badge bg-success">
                        <i class="fas fa-circle me-1" style="font-size: 8px;"></i>Online
                    </span>
                    <a href="{{ url_for('conversations') }}" class="btn btn-sm btn-light">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Context -->
    {% if current_product %}
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body bg-light">
            <div class="row align-items-center">
                <div class="col-md-2">
                    {% if current_product.get_primary_image() %}
                    <img src="{{ current_product.get_primary_image().get_image_url() }}"
                         class="img-fluid rounded" alt="{{ current_product.title }}" style="max-height: 80px;">
                    {% else %}
                    <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="height: 80px;">
                        <i class="fas fa-image text-white fa-2x"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-8">
                    <h6 class="mb-1">
                        <i class="fas fa-box me-2"></i>{{ current_product.title }}
                    </h6>
                    <p class="mb-1 text-muted small">{{ current_product.description[:100] }}...</p>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary">{{ current_product.get_final_barter_value() }} pts</span>
                        <span class="badge bg-secondary">{{ current_product.condition }}</span>
                        {% if current_product.estimated_value %}
                        <span class="badge bg-success">Rp {{ "{:,}".format(current_product.estimated_value|int) }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <a href="{{ url_for('product_detail', product_id=current_product.id) }}"
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-external-link-alt"></i> Detail
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Chat Area -->
    <div class="card border-0 shadow">
        <div class="card-body p-0">
            <div class="chat-container">
                <!-- Messages Area -->
                <div id="messagesArea" class="messages-area p-3" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                    <div id="messagesList">
                        <div class="text-center text-muted py-5" id="loadingIndicator">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Memuat pesan...</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="border-top bg-light p-2">
                    <div class="d-flex gap-2 flex-wrap">
                        {% if chat_type == 'buyer' and current_product %}
                        <button class="btn btn-sm btn-outline-primary" onclick="sendQuickMessage('Apakah produk ini masih tersedia?')">
                            <i class="fas fa-question-circle"></i> Tanya Ketersediaan
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="showOfferModal()">
                            <i class="fas fa-hand-holding-usd"></i> Buat Penawaran
                        </button>
                        {% elif chat_type == 'seller' and current_product %}
                        <button class="btn btn-sm btn-outline-success" onclick="sendQuickMessage('Produk masih tersedia dan siap dikirim!')">
                            <i class="fas fa-check-circle"></i> Konfirmasi Tersedia
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="showOfferModal()">
                            <i class="fas fa-tag"></i> Tawarkan Harga
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-info" onclick="sendQuickMessage('Terima kasih!')">
                            <i class="fas fa-heart"></i> Terima Kasih
                        </button>
                    </div>
                </div>

                <!-- Message Input Area -->
                <div class="border-top p-3 bg-white">
                    <form id="messageForm" class="d-flex gap-2">
                        <!-- Hidden Fields -->
                        <input type="hidden" id="receiverId" value="{{ other_user.id }}">
                        <input type="hidden" id="productId" value="{{ current_product.id if current_product else '' }}">
                        <input type="hidden" id="conversationId" value="{{ conversation_id }}">
                        <input type="hidden" id="messageType" value="text">

                        <!-- Message Input -->
                        <div class="flex-grow-1">
                            <input type="text" id="messageInput" class="form-control"
                                   placeholder="Ketik pesan Anda..." required>
                        </div>

                        <!-- Send Button -->
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Offer Modal -->
<div class="modal fade" id="offerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-hand-holding-usd me-2"></i>Buat Penawaran
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="offerForm">
                    <div class="mb-3">
                        <label class="form-label">Harga Penawaran (Rp)</label>
                        <input type="number" id="offerPrice" class="form-control"
                               placeholder="Masukkan harga..." required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jumlah</label>
                        <input type="number" id="offerQuantity" class="form-control"
                               value="1" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pesan Tambahan</label>
                        <textarea id="offerMessage" class="form-control" rows="3"
                                  placeholder="Jelaskan penawaran Anda..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button type="button" class="btn btn-success" onclick="submitOffer()">
                    <i class="fas fa-paper-plane"></i> Kirim Penawaran
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentConversationId = '{{ conversation_id }}';
let currentUserId = {{ current_user.id }};
let otherUserId = {{ other_user.id }};
let currentProductId = {{ current_product.id if current_product else 'null' }};
let refreshInterval;

// Initialize chat when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
});

function initializeChat() {
    // Load initial messages
    loadMessages();

    // Set up periodic refresh
    refreshInterval = setInterval(loadMessages, 3000); // Refresh every 3 seconds

    // Set up form submission
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
    }

    // Auto-focus message input
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.focus();

        // Handle Enter key
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
}

// Load messages function
    function loadMessages() {
        if (!currentConversationId) return;

        fetch(`/get_chat_messages/${currentConversationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayMessages(data.messages);
                    // Update unread count in navbar
                    updateUnreadCount();
                } else {
                    console.error('Failed to load messages:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading messages:', error);
            });
    }

    // Update unread count in navbar
    function updateUnreadCount() {
        fetch('/get_unread_chat_count')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const badge = document.getElementById('navbar-unread-count');
                    if (badge) {
                        if (data.unread_count > 0) {
                            badge.textContent = data.unread_count;
                            badge.style.display = 'inline';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error updating unread count:', error);
            });
    }

function displayMessages(messages) {
    const messagesList = document.getElementById('messagesList');
    const loadingIndicator = document.getElementById('loadingIndicator');

    if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
    }

    messagesList.innerHTML = '';

    if (messages.length === 0) {
        messagesList.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <h5>Belum ada pesan</h5>
                <p>Mulai percakapan dengan mengirim pesan pertama!</p>
            </div>
        `;
        return;
    }

    messages.forEach(message => {
        const messageElement = createMessageElement(message);
        messagesList.appendChild(messageElement);
    });

    // Scroll to bottom
    scrollToBottom();
}

function createMessageElement(message) {
    const div = document.createElement('div');
    const isOwn = message.sender_id === currentUserId;

    div.className = `message mb-3 ${isOwn ? 'text-end' : 'text-start'}`;

    let messageContent = '';

    if (message.message_type === 'offer') {
        messageContent = createOfferMessage(message, isOwn);
    } else if (message.message_type === 'deal') {
        messageContent = createDealMessage(message, isOwn);
    } else {
        messageContent = createTextMessage(message, isOwn);
    }

    div.innerHTML = messageContent;
    return div;
}

function createTextMessage(message, isOwn) {
    return `
        <div class="d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}">
            <div class="message-bubble ${isOwn ? 'bg-primary text-white' : 'bg-white border'} rounded p-3" style="max-width: 70%;">
                <p class="mb-1">${escapeHtml(message.message)}</p>
                <small class="opacity-75">
                    <i class="fas fa-clock me-1"></i>${message.created_at}
                </small>
            </div>
        </div>
    `;
}

function createOfferMessage(message, isOwn) {
    const isExpired = message.is_expired;
    const statusBadge = isExpired ?
        '<span class="badge bg-danger">Expired</span>' :
        '<span class="badge bg-success">Aktif</span>';

    let actionButtons = '';
    if (!isOwn && !isExpired && message.deal_accepted === null) {
        actionButtons = `
            <div class="mt-3">
                <button class="btn btn-success btn-sm me-2" onclick="respondToOffer(${message.id}, 'accept')">
                    <i class="fas fa-check"></i> Terima
                </button>
                <button class="btn btn-warning btn-sm me-2" onclick="respondToOffer(${message.id}, 'counter')">
                    <i class="fas fa-exchange-alt"></i> Counter
                </button>
                <button class="btn btn-danger btn-sm" onclick="respondToOffer(${message.id}, 'reject')">
                    <i class="fas fa-times"></i> Tolak
                </button>
            </div>
        `;
    }

    let dealStatus = '';
    if (message.deal_accepted === true) {
        dealStatus = '<div class="mt-2 text-success"><i class="fas fa-check-circle"></i> Deal Diterima!</div>';
    } else if (message.deal_accepted === false) {
        dealStatus = '<div class="mt-2 text-danger"><i class="fas fa-times-circle"></i> Deal Ditolak</div>';
    }

    return `
        <div class="d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}">
            <div class="card ${isOwn ? 'bg-primary text-white' : 'bg-light'}" style="max-width: 400px;">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong><i class="fas fa-hand-holding-usd"></i> Penawaran</strong>
                        ${statusBadge}
                    </div>
                    <div class="mb-2">
                        <h5 class="mb-1">Rp ${parseInt(message.offer_price || 0).toLocaleString()}</h5>
                        ${message.offer_quantity > 1 ? `<small>Jumlah: ${message.offer_quantity}</small>` : ''}
                    </div>
                    ${message.message ? `<p class="mb-2">${escapeHtml(message.message)}</p>` : ''}
                    <small class="opacity-75">
                        <i class="fas fa-clock me-1"></i>${message.created_at}
                    </small>
                    ${dealStatus}
                    ${actionButtons}
                </div>
            </div>
        </div>
    `;
}

function createDealMessage(message, isOwn) {
    return `
        <div class="d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}">
            <div class="card bg-success text-white" style="max-width: 400px;">
                <div class="card-body p-3">
                    <div class="mb-2">
                        <strong><i class="fas fa-handshake"></i> Deal Final</strong>
                    </div>
                    <p class="mb-2">${escapeHtml(message.message)}</p>
                    <small class="opacity-75">
                        <i class="fas fa-clock me-1"></i>${message.created_at}
                    </small>
                </div>
            </div>
        </div>
    `;
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();

    if (!message) {
        showAlert('Pesan tidak boleh kosong', 'warning');
        return;
    }

    // Disable input temporarily
    messageInput.disabled = true;

    const formData = new FormData();
    formData.append('receiver_id', document.getElementById('receiverId').value);
    formData.append('product_id', document.getElementById('productId').value);
    formData.append('message', message);
    formData.append('message_type', document.getElementById('messageType').value);

    fetch('/send_chat_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            document.getElementById('messageType').value = 'text';
            loadMessages(); // Refresh messages immediately
            showAlert('Pesan terkirim', 'success');
        } else {
            showAlert('Gagal mengirim pesan: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        showAlert('Terjadi kesalahan saat mengirim pesan', 'error');
    })
    .finally(() => {
        messageInput.disabled = false;
        messageInput.focus();
    });
}

function sendQuickMessage(message) {
    const messageInput = document.getElementById('messageInput');
    messageInput.value = message;
    sendMessage();
}

function showOfferModal() {
    const modal = new bootstrap.Modal(document.getElementById('offerModal'));
    modal.show();
}

function submitOffer() {
    const price = document.getElementById('offerPrice').value;
    const quantity = document.getElementById('offerQuantity').value;
    const message = document.getElementById('offerMessage').value;

    if (!price) {
        showAlert('Masukkan harga penawaran', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('receiver_id', document.getElementById('receiverId').value);
    formData.append('product_id', document.getElementById('productId').value);
    formData.append('message', message || `Penawaran: Rp ${parseInt(price).toLocaleString()}`);
    formData.append('message_type', 'offer');
    formData.append('offer_price', price);
    formData.append('offer_quantity', quantity);

    fetch('/send_chat_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('offerModal')).hide();
            document.getElementById('offerForm').reset();
            loadMessages();
            showAlert('Penawaran terkirim', 'success');
        } else {
            showAlert('Gagal mengirim penawaran: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error sending offer:', error);
        showAlert('Terjadi kesalahan saat mengirim penawaran', 'error');
    });
}

function respondToOffer(messageId, action) {
    let counterPrice = null;

    if (action === 'counter') {
        counterPrice = prompt('Masukkan harga counter offer:');
        if (counterPrice === null) return; // User cancelled
        if (isNaN(parseFloat(counterPrice))) {
            showAlert('Harga tidak valid', 'error');
            return;
        }
    }

    const formData = new FormData();
    formData.append('message_id', messageId);
    formData.append('action', action);
    if (counterPrice) {
        formData.append('counter_price', counterPrice);
    }

    fetch('/respond_to_offer', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadMessages();
            showAlert(data.message, 'success');
        } else {
            showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error responding to offer:', error);
        showAlert('Terjadi kesalahan saat merespons penawaran', 'error');
    });
}

function scrollToBottom() {
    const messagesArea = document.getElementById('messagesArea');
    if (messagesArea) {
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alert);

    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>

<style>
.chat-container {
    height: 600px;
    display: flex;
    flex-direction: column;
}

.messages-area {
    flex: 1;
    overflow-y: auto;
}

.message-bubble {
    max-width: 70%;
    word-wrap: break-word;
}

.messages-area::-webkit-scrollbar {
    width: 6px;
}

.messages-area::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.messages-area::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.messages-area::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.message {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}