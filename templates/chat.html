{% extends "base.html" %}

{% block title %}Chat dengan {{ other_user.get_full_name() }} - BarterHub{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <!-- Chat Header -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-circle fa-2x me-3"></i>
                            <div>
                                <h5 class="mb-0">{{ other_user.get_full_name() }}</h5>
                                <small class="opacity-75">
                                    {% if chat_type == 'seller' %}
                                    Penjual - @{{ other_user.username }}
                                    {% else %}
                                    Pembeli - @{{ other_user.username }}
                                    {% endif %}
                                    {% if current_product %}
                                    | Produk: {{ current_product.title }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% if conversation and conversation.status %}
                        <div class="text-end">
                            <span class="badge bg-light text-dark">
                                {% if conversation.status == 'active' %}
                                üí¨ Aktif
                                {% elif conversation.status == 'negotiating' %}
                                ü§ù Negosiasi
                                {% elif conversation.status == 'deal_pending' %}
                                ‚è≥ Menunggu Deal
                                {% elif conversation.status == 'completed' %}
                                ‚úÖ Deal Selesai
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                        <div class="d-flex gap-2">
                            <span class="badge bg-success">Online</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="row mt-3">
        <!-- Chat Messages Column -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-body d-flex flex-column p-0">
                    <!-- Messages Area -->
                    <div id="messagesArea" class="flex-grow-1 p-3" style="overflow-y: auto; max-height: 450px; min-height: 300px;">
                        <div id="messagesList">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <p>Mulai percakapan dengan {{ other_user.get_full_name() }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="border-top p-2">
                        <div class="d-flex gap-2 mb-2 flex-wrap">
                            {% if chat_type == 'seller' and current_product %}
                            <button class="btn btn-sm btn-outline-success" onclick="sendQuickOffer()">
                                üí∞ Tawarkan Harga
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="sendQuickMessage('Produk masih tersedia dan siap dikirim')">
                                ‚úÖ Konfirmasi Tersedia
                            </button>
                            {% elif chat_type == 'buyer' and current_product %}
                            <button class="btn btn-sm btn-outline-primary" onclick="sendQuickMessage('Apakah produk ini masih tersedia?')">
                                ‚ùì Tanya Ketersediaan
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="sendQuickOffer()">
                                ü§ù Buat Penawaran
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-outline-success" onclick="sendQuickMessage('Terima kasih sudah menghubungi saya')">
                                üôè Ucapan Terima Kasih
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="showShippingCalculator()">
                                üì¶ Cek Ongkir
                            </button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Message Input - SINGLE INPUT FORM -->
                    <div class="border-top p-3">
                        <form id="messageForm" class="d-flex gap-2">
                            <input type="hidden" id="receiverId" value="{{ other_user.id }}">
                            <input type="hidden" id="productId" value="{{ current_product.id if current_product else '' }}">
                            <input type="hidden" id="conversationId" value="{{ conversation_id }}">
                            <input type="hidden" id="messageType" value="text">

                            <div class="flex-grow-1">
                                <input type="text" id="messageInput" class="form-control" placeholder="Ketik pesan..." required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Sidebar -->
        <div class="col-lg-4">
            {% if chat_type == 'seller' and products %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-store me-2"></i>Produk dari {{ other_user.get_full_name() }}</h6>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% for product in products %}
                    <div class="product-item border-bottom pb-2 mb-2 cursor-pointer" onclick="selectProduct({{ product.id }}, '{{ product.title }}')">
                        <div class="d-flex">
                            <div class="me-2">
                                {% if product.image_url %}
                                <img src="{{ product.image_url }}" width="50" height="50" class="rounded" alt="{{ product.title }}">
                                {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 small">{{ product.title }}</h6>
                                <div class="d-flex gap-1">
                                    <span class="badge bg-primary small">{{ product.get_final_barter_value() }} pts</span>
                                    <span class="badge bg-secondary small">{{ product.condition }}</span>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="startProductChat({{ product.id }}, '{{ product.title }}')">
                                    <i class="fas fa-comment"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% elif chat_type == 'buyer' and cart_items %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Keranjang {{ other_user.get_full_name() }}</h6>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% for cart_item in cart_items %}
                    <div class="cart-item border-bottom pb-2 mb-2">
                        <div class="d-flex">
                            <div class="me-2">
                                {% if cart_item.product.image_url %}
                                <img src="{{ cart_item.product.image_url }}" width="50" height="50" class="rounded" alt="{{ cart_item.product.title }}">
                                {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 small">{{ cart_item.product.title }}</h6>
                                <small class="text-muted">Dari toko Anda</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Aksi Cepat</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if chat_type == 'seller' %}
                        <button class="btn btn-outline-success btn-sm" onclick="sendQuickMessage('Apakah produk ini masih tersedia?')">
                            <i class="fas fa-question-circle me-1"></i>Tanya Ketersediaan
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="sendQuickMessage('Bisa nego harganya?')">
                            <i class="fas fa-handshake me-1"></i>Tanya Negosiasi
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="sendQuickMessage('Bagaimana kondisi barangnya?')">
                            <i class="fas fa-search me-1"></i>Tanya Kondisi
                        </button>
                        {% else %}
                        <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMessage('Terima kasih sudah tertarik dengan produk saya')">
                            <i class="fas fa-thumbs-up me-1"></i>Ucapan Terima Kasih
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="sendQuickMessage('Produk masih tersedia dan siap dikirim')">
                            <i class="fas fa-check me-1"></i>Konfirmasi Tersedia
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Offer Modal -->
<div class="modal fade" id="offerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üí∞ Buat Penawaran</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="offerForm">
                    <div class="mb-3">
                        <label class="form-label">Harga Penawaran (Rp)</label>
                        <input type="number" id="offerPrice" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jumlah</label>
                        <input type="number" id="offerQuantity" class="form-control" value="1" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pesan Tambahan</label>
                        <textarea id="offerMessage" class="form-control" rows="3" placeholder="Tuliskan pesan tambahan..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="submitOffer()">Kirim Penawaran</button>
            </div>
        </div>
    </div>
</div>

<!-- Shipping Modal -->
<div class="modal fade" id="shippingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üöö Cek Ongkos Kirim</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="shippingForm">
                    <input type="hidden" name="product_id" value="{{ current_product.id if current_product else '' }}">
                    <div class="mb-3">
                        <label class="form-label">Asal Kota/Gudang</label>
                        <input type="text" name="origin_city" class="form-control" placeholder="Masukkan kota asal">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tujuan Kota</label>
                        <input type="text" name="destination_city" class="form-control" placeholder="Masukkan kota tujuan">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Berat (kg)</label>
                        <input type="number" name="weight" class="form-control" placeholder="Masukkan berat produk">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="calculateShipping()">Cek Ongkir</button>
                </form>
                <div id="shippingResults" class="mt-4" style="display: none;">
                    <h6>Hasil Ongkos Kirim:</h6>
                    <div id="shippingRates">
                        <!-- Shipping rates will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let conversationId = '{{ conversation_id }}';
let currentUserId = {{ current_user.id }};
let otherUserId = {{ other_user.id }};
let currentProductId = {{ current_product.id if current_product else 'null' }};

document.addEventListener('DOMContentLoaded', function() {
    loadMessages();
    setInterval(loadMessages, 3000); // Refresh every 3 seconds
});

// Load messages
function loadMessages() {
    fetch(`/get_chat_messages/${conversationId}`)
        .then(response => response.json())
        .then(data => {
            if (data.messages) {
                displayMessages(data.messages);
                updateConversationStatus(data.conversation);
            }
        })
        .catch(error => console.error('Error:', error));
}

// Display messages
function displayMessages(messages) {
    const messagesList = document.getElementById('messagesList');
    messagesList.innerHTML = '';

    if (messages.length === 0) {
        messagesList.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-comments fa-2x mb-2"></i>
                <p>Mulai percakapan dengan {{ other_user.get_full_name() }}</p>
            </div>
        `;
        return;
    }

    messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        const isSender = msg.sender_id === currentUserId;
        messageDiv.className = `message mb-3 ${isSender ? 'text-end' : 'text-start'}`;

        let messageContent = '';

        if (msg.message_type === 'offer') {
            messageContent = `
                <div class="card ${isSender ? 'bg-primary text-white' : 'bg-light'}" style="max-width: 400px; ${isSender ? 'margin-left: auto;' : ''}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>üí∞ Penawaran</strong>
                            <span class="badge ${msg.is_expired ? 'bg-danger' : 'bg-success'}">
                                ${msg.is_expired ? 'Expired' : 'Aktif'}
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Rp ${parseInt(msg.offer_price || 0).toLocaleString()}</strong>
                            ${msg.offer_quantity > 1 ? ` x ${msg.offer_quantity}` : ''}
                        </div>
                        <p class="mb-2">${msg.message || ''}</p>
                        <small class="opacity-75">${msg.created_at}</small>

                        ${!isSender && !msg.is_expired && msg.deal_accepted === null ? `
                            <div class="mt-2">
                                <button class="btn btn-sm btn-success me-1" onclick="respondToOffer(${msg.id}, 'accept')">
                                    ‚úÖ Terima
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="respondToOffer(${msg.id}, 'counter')">
                                    üîÑ Counter
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="respondToOffer(${msg.id}, 'reject')">
                                    ‚ùå Tolak
                                </button>
                            </div>
                        ` : ''}

                        ${!isSender && msg.message_type === 'deal' && msg.is_deal && msg.deal_accepted === null ? `
                            <div class="mt-2">
                                <button class="btn btn-sm btn-success me-1" onclick="confirmDeal(${msg.id}, 'accept')">
                                    ‚úÖ Terima Deal
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDeal(${msg.id}, 'reject')">
                                    ‚ùå Tolak Deal
                                </button>
                            </div>
                        ` : ''}

                        ${msg.deal_accepted === true ? '<div class="mt-2 text-success">‚úÖ Deal Diterima!</div>' : ''}
                        ${msg.deal_accepted === false ? '<div class="mt-2 text-danger">‚ùå Deal Ditolak</div>' : ''}
                    </div>
                </div>
            `;
        } else if (msg.message_type === 'deal') {
            messageContent = `
                <div class="card bg-success text-white" style="max-width: 400px; ${isSender ? 'margin-left: auto;' : ''}">
                    <div class="card-body p-3">
                        <div class="mb-2"><strong>üéâ Deal Final</strong></div>
                        <p class="mb-2">${msg.message}</p>
                        <small class="opacity-75">${msg.created_at}</small>
                    </div>
                </div>
            `;
        } else {
            messageContent = `
                <div class="d-flex ${isSender ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="message-bubble ${isSender ? 'bg-primary text-white' : 'bg-light'} rounded p-3" style="max-width: 70%;">
                        <p class="mb-1">${msg.message}</p>
                        <small class="opacity-75">${msg.created_at}</small>
                    </div>
                </div>
            `;
        }

        messageDiv.innerHTML = messageContent;
        messagesList.appendChild(messageDiv);
    });

    document.getElementById('messagesArea').scrollTop = document.getElementById('messagesArea').scrollHeight;
}

// Send message - SINGLE FORM HANDLER
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage();
});

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();

    if (!message) return;

    const formData = new FormData();
    formData.append('receiver_id', document.getElementById('receiverId').value);
    formData.append('product_id', document.getElementById('productId').value);
    formData.append('message', message);
    formData.append('message_type', document.getElementById('messageType').value);

    fetch('/send_chat_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            document.getElementById('messageType').value = 'text';
            loadMessages();
        } else {
            alert('Gagal mengirim pesan: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat mengirim pesan');
    });
}

// Quick message
function sendQuickMessage(message) {
    document.getElementById('messageInput').value = message;
    sendMessage();
}

// Quick offer
function sendQuickOffer() {
    new bootstrap.Modal(document.getElementById('offerModal')).show();
}

// Submit offer
function submitOffer() {
    const price = document.getElementById('offerPrice').value;
    const quantity = document.getElementById('offerQuantity').value;
    const message = document.getElementById('offerMessage').value;

    if (!price) {
        alert('Masukkan harga penawaran');
        return;
    }

    const formData = new FormData();
    formData.append('receiver_id', document.getElementById('receiverId').value);
    formData.append('product_id', document.getElementById('productId').value);
    formData.append('message', message || `Penawaran untuk produk ini: Rp ${parseInt(price).toLocaleString()}`);
    formData.append('message_type', 'offer');
    formData.append('offer_price', price);
    formData.append('offer_quantity', quantity);

    fetch('/send_chat_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('offerModal')).hide();
            document.getElementById('offerForm').reset();
            loadMessages();
        } else {
            alert('Gagal mengirim penawaran: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat mengirim penawaran');
    });
}

// Shipping calculator
function showShippingCalculator() {
    new bootstrap.Modal(document.getElementById('shippingModal')).show();
}

function calculateShipping() {
    const formData = new FormData(document.getElementById('shippingForm'));

    fetch('/get_shipping_rates', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayShippingRates(data.rates);
            document.getElementById('shippingResults').style.display = 'block';
        } else {
            alert('Error calculating shipping rates: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat menghitung ongkir');
    });
}

function displayShippingRates(rates) {
    const container = document.getElementById('shippingRates');
    let html = '';

    for (const courier in rates) {
        html += `<div class="mb-3">
            <h6 class="text-primary">${courier}</h6>
            <div class="row">`;

        for (const service in rates[courier]) {
            const rate = rates[courier][service];
            html += `
                <div class="col-md-6 mb-2">
                    <div class="card">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${rate.service}</strong><br>
                                    <small class="text-muted">${rate.days} hari</small>
                                </div>
                                <div class="text-end">
                                    <strong>Rp ${rate.price.toLocaleString()}</strong><br>
                                    <button class="btn btn-sm btn-outline-primary"
                                            onclick="useShippingRate('${courier}', '${rate.service}', ${rate.price})">
                                        Pilih
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        html += '</div></div>';
    }

    container.innerHTML = html;
}

function useShippingRate(courier, service, price) {
    const message = `üì¶ Ongkir ${courier} - ${service}: Rp ${price.toLocaleString()}`;
    sendChatMessage(message, 'shipping_info');
    bootstrap.Modal.getInstance(document.getElementById('shippingModal')).hide();
}

// Helper to send chat messages with a specific type
function sendChatMessage(message, messageType) {
    const formData = new FormData();
    formData.append('receiver_id', document.getElementById('receiverId').value);
    formData.append('product_id', document.getElementById('productId').value);
    formData.append('message', message);
    formData.append('message_type', messageType);

    fetch('/send_chat_message', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadMessages();
        } else {
            alert('Gagal mengirim pesan: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => console.error('Error sending chat message:', error));
}

// Respond to offer
function respondToOffer(messageId, action, counterPrice = null) {
    const formData = new FormData();
    formData.append('message_id', messageId);
    formData.append('action', action);

    if (action === 'counter') {
        const priceInput = prompt('Masukkan harga counter offer:');
        if (priceInput === null) return; // User cancelled
        if (isNaN(parseFloat(priceInput))) {
            alert('Harga tidak valid.');
            return;
        }
        formData.append('counter_price', priceInput);
    }

    const responseMsg = prompt('Tambahkan pesan (opsional):');
    if (responseMsg !== null) {
        formData.append('response_message', responseMsg);
    }

    fetch('/respond_to_offer', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadMessages();
            if (action === 'accept') {
                alert('Penawaran berhasil diterima!');
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat merespons penawaran');
    });
}

// Deal confirmation
function confirmDeal(messageId, action) {
    if (!messageId || !action) {
        alert('Data tidak valid');
        return;
    }

    const confirmMessage = action === 'accept' 
        ? 'Apakah Anda yakin ingin menerima deal ini? Setelah diterima, deal akan menjadi mengikat.'
        : 'Apakah Anda yakin ingin menolak deal ini?';

    if (!confirm(confirmMessage)) {
        return;
    }

    const formData = new FormData();
    formData.append('message_id', messageId);
    formData.append('action', action);

    fetch('/confirm_deal', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadMessages();

            if (action === 'accept') {
                setTimeout(() => {
                    alert('üéâ Selamat! Deal berhasil disepakati. Silakan cek halaman pesanan untuk detail selanjutnya.');
                }, 1000);
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat memproses deal');
    });
}

// Start product-specific chat
function startProductChat(productId, productTitle) {
    document.getElementById('productId').value = productId;
    document.getElementById('messageInput').placeholder = `Tanya tentang: ${productTitle}`;
}

// Select product for context
function selectProduct(productId, productTitle) {
    document.getElementById('productId').value = productId;
    document.getElementById('messageInput').placeholder = `Tanya tentang: ${productTitle}`;
    document.getElementById('messageInput').focus();
}

// Update conversation status (placeholder)
function updateConversationStatus(conversation) {
    if (conversation) {
        console.log('Conversation status:', conversation.status);
    }
}
</script>

<style>
.cursor-pointer {
    cursor: pointer;
}

.product-item:hover, .cart-item:hover {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 5px;
}

.message-bubble {
    max-width: 70%;
    margin-bottom: 10px;
}

#messagesArea {
    background-color: #f8f9fa;
}

.card-body.p-3 {
    position: relative;
}

.card-body .badge {
    position: absolute;
    top: 10px;
    right: 10px;
}

/* Scrollbar styling */
#messagesArea::-webkit-scrollbar {
    width: 6px;
}

#messagesArea::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#messagesArea::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

#messagesArea::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %}