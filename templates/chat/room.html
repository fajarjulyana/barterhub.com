{% extends "base.html" %}

{% block title %}Chat Negosiasi - {{ product.name }} - BarterHub{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- Chat Messages Area -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <!-- Chat Header -->
                <div class="chat-header-detail bg-gradient text-white p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="chat-avatar me-3">
                                <i class="fas fa-user-circle fs-2"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">
                                    {% if current_user.id == chat_room.seller_id %}
                                        {{ chat_room.buyer.full_name }}
                                    {% else %}
                                        {{ chat_room.seller.full_name }}
                                    {% endif %}
                                </h6>
                                <small class="opacity-75">Negosiasi untuk: {{ product.name }}</small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="toggleNegotiationPanel()">
                                <i class="fas fa-handshake me-1"></i>Negosiasi
                            </button>
                            <a href="{{ url_for('products.detail', id=product.id) }}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="card-body p-0">
                    <div class="chat-messages-container" id="messagesContainer" style="height: 450px; overflow-y: auto;">
                        <div class="p-3">
                            <!-- System Welcome Message -->
                            <div class="system-message mb-3">
                                <div class="alert alert-info border-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Selamat datang di ruang negosiasi!</strong><br>
                                    <small>Anda dapat bernegosiasi dengan menawarkan dan meminta barang. Gunakan tombol "Negosiasi" untuk memulai penawaran.</small>
                                </div>
                            </div>

                            {% if messages %}
                                {% for message in messages %}
                                <div class="message-item mb-3" data-message-id="{{ message.id }}">
                                    {% if message.message_type == 'text' %}
                                        <!-- Text Message -->
                                        <div class="d-flex {% if message.sender_id == current_user.id %}justify-content-end{% endif %}">
                                            <div class="message-bubble {% if message.sender_id == current_user.id %}bg-primary text-white align-self-end{% else %}bg-light text-dark{% endif %} rounded-4 p-3 max-width-75">
                                                <div class="message-header mb-1">
                                                    <small class="{% if message.sender_id == current_user.id %}text-white-50{% else %}text-muted{% endif %}">
                                                        {{ message.sender.full_name }}
                                                        <span class="ms-2">{{ message.created_at.strftime('%d/%m %H:%M') }}</span>
                                                    </small>
                                                </div>
                                                <div class="message-content">{{ message.message }}</div>
                                            </div>
                                        </div>

                                    {% elif message.message_type == 'offer' %}
                                        <!-- Offer Message -->
                                        <div class="negotiation-message mb-4">
                                            <div class="card border-warning bg-warning-subtle">
                                                <div class="card-header bg-warning text-dark">
                                                    <div class="d-flex align-items-center justify-content-between">
                                                        <div>
                                                            <i class="fas fa-handshake me-2"></i>
                                                            <strong>Penawaran dari {{ message.sender.full_name }}</strong>
                                                        </div>
                                                        <small>{{ message.created_at.strftime('%d/%m %H:%M') }}</small>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <p class="mb-3">{{ message.message }}</p>
                                                    
                                                    <!-- Offered Products -->
                                                    {% if message.offered_products_json %}
                                                    <div class="offered-products mb-3">
                                                        <h6 class="text-success mb-2">
                                                            <i class="fas fa-gift me-1"></i>Menawarkan:
                                                        </h6>
                                                        <!-- Parse and display offered products -->
                                                    </div>
                                                    {% endif %}
                                                    
                                                    <!-- Requested Products -->
                                                    {% if message.requested_products_json %}
                                                    <div class="requested-products mb-3">
                                                        <h6 class="text-info mb-2">
                                                            <i class="fas fa-shopping-cart me-1"></i>Meminta:
                                                        </h6>
                                                        <!-- Parse and display requested products -->
                                                    </div>
                                                    {% endif %}

                                                    {% if message.sender_id != current_user.id %}
                                                    <div class="offer-actions">
                                                        <button class="btn btn-success btn-sm me-2" onclick="acceptOffer({{ message.id }})">
                                                            <i class="fas fa-check me-1"></i>Terima
                                                        </button>
                                                        <button class="btn btn-outline-primary btn-sm me-2" onclick="counterOffer({{ message.id }})">
                                                            <i class="fas fa-exchange-alt me-1"></i>Tawar Balik
                                                        </button>
                                                        <button class="btn btn-outline-danger btn-sm" onclick="declineOffer({{ message.id }})">
                                                            <i class="fas fa-times me-1"></i>Tolak
                                                        </button>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                    {% elif message.message_type == 'system' %}
                                        <!-- System Message -->
                                        <div class="system-message mb-3">
                                            <div class="alert alert-secondary border-0 text-center">
                                                <small><i class="fas fa-robot me-1"></i>{{ message.message }}</small>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-comments fs-2 mb-3"></i>
                                    <p>Belum ada pesan. Mulai percakapan atau buat penawaran!</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="card-footer bg-white border-top">
                    <form method="POST" class="d-flex gap-2 align-items-end">
                        {{ form.hidden_tag() }}
                        <div class="flex-grow-1">
                            {{ form.message(class="form-control border-0 bg-light", placeholder="Tulis pesan...", rows="2", style="resize: none;") }}
                        </div>
                        <div class="d-flex flex-column gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleNegotiationPanel()" title="Buat Penawaran">
                                <i class="fas fa-handshake"></i>
                            </button>
                            <button type="submit" class="btn btn-primary" title="Kirim Pesan">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Product Info -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="position-relative">
                    {% set main_image = product.get_main_image() %}
                    <img src="{{ url_for('static', filename='uploads/products/' + main_image) if main_image else 'https://via.placeholder.com/300x200?text=No+Image' }}" 
                         class="card-img-top" style="height: 200px; object-fit: cover;" alt="{{ product.name }}">
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-primary fs-6">{{ product.total_points }} Poin</span>
                    </div>
                </div>
                <div class="card-body">
                    <h6 class="card-title">{{ product.name }}</h6>
                    <p class="card-text text-muted small">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</p>
                    
                    <div class="product-details mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                                <i class="fas fa-tag me-1"></i>{{ product.category.name }}
                            </small>
                            <span class="badge bg-{{ 'success' if product.condition == 'Baru' else 'warning' }}">
                                {{ product.condition }}
                            </span>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ product.owner.address or 'Lokasi tidak tersedia' }}
                            </small>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>{{ product.owner.full_name }}
                            </small>
                            <small class="text-muted">
                                {{ product.created_at.strftime('%d/%m/%Y') }}
                            </small>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="{{ url_for('products.detail', id=product.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>Lihat Detail Produk
                        </a>
                    </div>
                </div>
            </div>

            <!-- Negotiation Quick Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt text-warning me-2"></i>Aksi Cepat
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" onclick="toggleNegotiationPanel()">
                            <i class="fas fa-handshake me-2"></i>Buat Penawaran Barter
                        </button>
                        <button class="btn btn-outline-success" onclick="sendQuickMessage('Apakah barang ini masih tersedia?')">
                            <i class="fas fa-question-circle me-2"></i>Tanya Ketersediaan
                        </button>
                        <button class="btn btn-outline-info" onclick="sendQuickMessage('Bisakah saya lihat foto lebih detail?')">
                            <i class="fas fa-camera me-2"></i>Minta Foto Detail
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Negotiation Panel Modal -->
<div class="modal fade" id="negotiationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-handshake me-2"></i>Buat Penawaran Negosiasi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="negotiationForm">
                    <div class="row g-4">
                        <!-- Offering Section -->
                        <div class="col-md-6">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-gift me-2"></i>Yang Anda Tawarkan
                            </h6>
                            <div class="offer-products-list" id="offerProductsList">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addOfferProduct()">
                                <i class="fas fa-plus me-1"></i>Tambah Produk
                            </button>
                        </div>

                        <!-- Requesting Section -->
                        <div class="col-md-6">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-shopping-cart me-2"></i>Yang Anda Minta
                            </h6>
                            <div class="request-products-list" id="requestProductsList">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addRequestProduct()">
                                <i class="fas fa-plus me-1"></i>Tambah Produk
                            </button>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label">Pesan Negosiasi</label>
                        <textarea class="form-control" id="negotiationMessage" rows="3" 
                                  placeholder="Tulis pesan untuk melengkapi penawaran Anda..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-warning" onclick="submitNegotiation()">
                    <i class="fas fa-handshake me-1"></i>Kirim Penawaran
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chat functionality
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;
}

function toggleNegotiationPanel() {
    const modal = new bootstrap.Modal(document.getElementById('negotiationModal'));
    modal.show();
    loadUserProducts();
}

function sendQuickMessage(message) {
    document.querySelector('textarea[name="message"]').value = message;
    document.querySelector('textarea[name="message"]').focus();
}

function loadUserProducts() {
    // Load user's available products for offering
    fetch('/products/user/available')
        .then(response => response.json())
        .then(data => {
            // Populate offer products list
            updateProductsList('offerProductsList', data.products, 'offer');
        });
}

function addOfferProduct() {
    // Add product selection to offer list
    const container = document.getElementById('offerProductsList');
    const productItem = createProductSelector('offer');
    container.appendChild(productItem);
}

function addRequestProduct() {
    // Add product to request list (manual input or from existing products)
    const container = document.getElementById('requestProductsList');
    const productItem = createProductSelector('request');
    container.appendChild(productItem);
}

function createProductSelector(type) {
    const div = document.createElement('div');
    div.className = 'product-selector mb-2 p-3 border rounded';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <select class="form-select form-select-sm">
                <option value="">Pilih produk...</option>
                <!-- Options will be populated dynamically -->
            </select>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="row g-2">
            <div class="col">
                <input type="number" class="form-control form-control-sm" placeholder="Jumlah" min="1" value="1">
            </div>
            <div class="col">
                <input type="text" class="form-control form-control-sm" placeholder="Catatan (opsional)">
            </div>
        </div>
    `;
    return div;
}

function submitNegotiation() {
    const message = document.getElementById('negotiationMessage').value;
    const offerProducts = collectProducts('offerProductsList');
    const requestProducts = collectProducts('requestProductsList');
    
    const data = {
        message: message,
        message_type: 'offer',
        offered_products: offerProducts,
        requested_products: requestProducts
    };
    
    fetch(window.location.pathname + '/send_negotiation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show new message
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function collectProducts(containerId) {
    const container = document.getElementById(containerId);
    const products = [];
    
    container.querySelectorAll('.product-selector').forEach(selector => {
        const productId = selector.querySelector('select').value;
        const quantity = selector.querySelector('input[type="number"]').value;
        const note = selector.querySelectorAll('input')[1].value;
        
        if (productId) {
            products.push({
                product_id: parseInt(productId),
                quantity: parseInt(quantity) || 1,
                note: note
            });
        }
    });
    
    return products;
}

function acceptOffer(messageId) {
    if (confirm('Apakah Anda yakin menerima penawaran ini?')) {
        fetch(`/chat/offer/${messageId}/accept`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function counterOffer(messageId) {
    // Load the original offer data and pre-populate negotiation form
    toggleNegotiationPanel();
    // TODO: Pre-populate form with original offer data for counter-offer
}

function declineOffer(messageId) {
    const reason = prompt('Alasan menolak (opsional):');
    fetch(`/chat/offer/${messageId}/decline`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({reason: reason})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

// Auto-scroll to bottom and refresh messages
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    
    // Refresh messages every 5 seconds
    setInterval(function() {
        // Auto-refresh could be implemented here
    }, 5000);
});
</script>
{% endblock %}