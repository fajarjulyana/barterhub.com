
{% extends "base.html" %}

{% block title %}Struk Resi Transaksi - {{ receipt.receipt_number }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Receipt Header -->
            <div class="card border-success shadow-lg">
                <div class="card-header bg-success text-white text-center py-4">
                    <h3 class="mb-1"><i class="fas fa-receipt me-2"></i>STRUK RESI TRANSAKSI BARTER</h3>
                    <h4 class="mb-0">{{ receipt.receipt_number }}</h4>
                    <small>{{ receipt.created_at.strftime('%d %B %Y, %H:%M WIB') }}</small>
                </div>
                
                <div class="card-body p-4">
                    <!-- Transaction Status -->
                    <div class="text-center mb-4">
                        <span class="badge fs-6 bg-{% if receipt.transaction_status == 'confirmed' %}warning{% elif receipt.transaction_status == 'shipping_arranged' %}info{% elif receipt.transaction_status == 'shipped' %}primary{% else %}success{% endif %}">
                            {% if receipt.transaction_status == 'confirmed' %}Transaksi Dikonfirmasi
                            {% elif receipt.transaction_status == 'shipping_arranged' %}Pengiriman Diatur
                            {% elif receipt.transaction_status == 'shipped' %}Telah Dikirim
                            {% else %}Selesai
                            {% endif %}
                        </span>
                    </div>
                    
                    <!-- Transaction Parties -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="border rounded p-3 bg-light">
                                <h6 class="text-success"><i class="fas fa-store me-2"></i>PENJUAL</h6>
                                <strong>{{ receipt.seller_name }}</strong><br>
                                <small class="text-muted">{{ receipt.proposal.proposal_receiver.email }}</small><br>
                                <small class="text-muted">{{ receipt.proposal.proposal_receiver.phone or 'No telepon tidak tersedia' }}</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 bg-light">
                                <h6 class="text-primary"><i class="fas fa-user me-2"></i>PEMBELI</h6>
                                <strong>{{ receipt.buyer_name }}</strong><br>
                                <small class="text-muted">{{ receipt.proposal.proposer.email }}</small><br>
                                <small class="text-muted">{{ receipt.proposal.proposer.phone or 'No telepon tidak tersedia' }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Item Exchange Details -->
                    <div class="card border-0 bg-light mb-4">
                        <div class="card-header bg-transparent border-0">
                            <h5 class="mb-0"><i class="fas fa-exchange-alt me-2 text-warning"></i>DETAIL PERTUKARAN BARANG</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        {% if receipt.proposal.offered_product.image_filename %}
                                        <img src="{{ url_for('static', filename='uploads/' + receipt.proposal.offered_product.image_filename) }}" 
                                             class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                        {% endif %}
                                        <div>
                                            <strong class="text-primary">Barang Ditawarkan:</strong><br>
                                            {{ receipt.main_item_offered }}<br>
                                            <small class="text-muted">Kondisi: {{ receipt.proposal.offered_product.condition }}</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        {% if receipt.proposal.wanted_product.image_filename %}
                                        <img src="{{ url_for('static', filename='uploads/' + receipt.proposal.wanted_product.image_filename) }}" 
                                             class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                        {% endif %}
                                        <div>
                                            <strong class="text-success">Barang Diinginkan:</strong><br>
                                            {{ receipt.main_item_wanted }}<br>
                                            <small class="text-muted">Kondisi: {{ receipt.proposal.wanted_product.condition }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if receipt.additional_items_detail %}
                            <div class="mt-3 p-3 bg-warning bg-opacity-25 rounded">
                                <strong><i class="fas fa-plus me-2"></i>Barang/Kompensasi Tambahan:</strong><br>
                                {{ receipt.additional_items_detail }}
                            </div>
                            {% endif %}
                            
                            {% if receipt.final_agreed_price %}
                            <div class="mt-3 p-3 bg-info bg-opacity-25 rounded">
                                <strong><i class="fas fa-money-bill me-2"></i>Nilai Kesepakatan:</strong> 
                                Rp {{ "{:,.0f}".format(receipt.final_agreed_price) }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Shipping Information -->
                    {% if receipt.shipping_details %}
                    <div class="card border-0 bg-light mb-4">
                        <div class="card-header bg-transparent border-0">
                            <h5 class="mb-0"><i class="fas fa-shipping-fast me-2 text-info"></i>INFORMASI PENGIRIMAN</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Kurir:</strong> {{ receipt.shipping_method }}<br>
                                    <strong>Ongkir:</strong> Rp {{ "{:,.0f}".format(receipt.shipping_cost) if receipt.shipping_cost else '0' }}<br>
                                    <strong>Estimasi:</strong> {{ receipt.shipping_details[0].estimated_delivery }} hari
                                </div>
                                <div class="col-md-4">
                                    <strong>Berat:</strong> {{ receipt.shipping_details[0].package_weight }} kg<br>
                                    <strong>Dimensi:</strong> {{ receipt.shipping_details[0].package_dimensions or '-' }}<br>
                                    <strong>Asuransi:</strong> Rp {{ "{:,.0f}".format(receipt.shipping_details[0].insurance_value) if receipt.shipping_details[0].insurance_value else '0' }}
                                </div>
                                <div class="col-md-4">
                                    {% if receipt.tracking_number %}
                                    <strong>No. Resi:</strong><br>
                                    <code class="fs-6">{{ receipt.tracking_number }}</code>
                                    {% else %}
                                    <span class="text-muted">No. resi belum tersedia</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Pengirim (Pembeli):</h6>
                                    <address>
                                        <strong>{{ receipt.shipping_details[0].sender_name }}</strong><br>
                                        {{ receipt.shipping_details[0].sender_address }}<br>
                                        Telp: {{ receipt.shipping_details[0].sender_phone }}
                                    </address>
                                </div>
                                <div class="col-md-6">
                                    <h6>Penerima (Penjual):</h6>
                                    <address>
                                        <strong>{{ receipt.shipping_details[0].receiver_name }}</strong><br>
                                        {{ receipt.shipping_details[0].receiver_address }}<br>
                                        Telp: {{ receipt.shipping_details[0].receiver_phone }}
                                    </address>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Action Buttons -->
                    <div class="text-center">
                        {% if current_user.id == receipt.proposal.proposer_id and receipt.transaction_status == 'confirmed' %}
                            <a href="{{ url_for('setup_shipping', receipt_id=receipt.id) }}" class="btn btn-primary me-2">
                                <i class="fas fa-truck me-1"></i>Atur Pengiriman
                            </a>
                        {% endif %}
                        
                        {% if current_user.id == receipt.proposal.proposer_id and receipt.transaction_status == 'shipping_arranged' %}
                            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#trackingModal">
                                <i class="fas fa-barcode me-1"></i>Update No. Resi
                            </button>
                        {% endif %}
                        
                        <button onclick="window.print()" class="btn btn-outline-secondary">
                            <i class="fas fa-print me-1"></i>Cetak Struk
                        </button>
                        
                        <a href="{{ url_for('proposal_detail', proposal_id=receipt.proposal_id) }}" class="btn btn-outline-info">
                            <i class="fas fa-arrow-left me-1"></i>Kembali ke Proposal
                        </a>
                    </div>
                    
                    <!-- Terms and Conditions -->
                    <div class="mt-5 pt-4 border-top">
                        <small class="text-muted">
                            <strong>SYARAT & KETENTUAN:</strong><br>
                            1. Pembeli bertanggung jawab atas biaya pengiriman<br>
                            2. Barang yang dikirim harus sesuai dengan deskripsi dan kesepakatan<br>
                            3. Penjual wajib mengkonfirmasi penerimaan barang dalam 3x24 jam<br>
                            4. Komplain dapat diajukan maksimal 2x24 jam setelah barang diterima<br>
                            5. BarterHub tidak bertanggung jawab atas kerusakan barang selama pengiriman tanpa asuransi
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tracking Number Modal -->
{% if current_user.id == receipt.proposal.proposer_id and receipt.transaction_status == 'shipping_arranged' %}
<div class="modal fade" id="trackingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Nomor Resi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('update_tracking', receipt_id=receipt.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nomor Resi Pengiriman</label>
                        <input type="text" name="tracking_number" class="form-control" 
                               placeholder="Masukkan nomor resi dari kurir" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Pastikan nomor resi sudah aktif dan dapat dilacak di website kurir.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success">Update Resi</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
@media print {
    .btn, .modal { display: none !important; }
    .card { border: 2px solid #000 !important; }
    .card-header { background-color: #28a745 !important; -webkit-print-color-adjust: exact; }
}
</style>
{% endblock %}
